#!/usr/bin/env perl

use strict;

use FindBin qw($Bin);
use lib "$Bin/../lib";

use Mojolicious::Lite;
use DDP;
use DateTime;

# Static files are automatically served from the /public subfolder.

get '/ping' => sub {
    my $self   = shift;
    my $result = {};
    return $self->render(json => { status => 'ok' });
};

get '/calendar/html' => sub {
    my $self = shift;

    my $dt = DateTime->now();

    #$dt = DateTime->new(year => '2023', month => 7, day => 31);  # mock

    $dt->set_locale('en-US');
    $self->stash(date => $dt);

    return $self->render(template => 'calendar', format => 'html');
};

get '/calendar/png' => sub {
    my $self = shift;

    return $self->render_file(
        'filepath'            => "$Bin/generated_images/current_calendar.png",
        'format'              => 'png',
        'content_disposition' => 'inline',
    ) || $self->render(json => { status => "No calendar available" });
};

get '/' => sub {
    my $self = shift;

    return $self->render(template => 'test', format => 'html');
};

plugin 'TagHelpers';
plugin 'RenderFile';

app->secrets(['My very secret passphsasdfi903478ty90 e8gd opasjf23[f- rase.']);    # FIXME  FIXME
app->start;
