@model List<Display>
@using PortalCalendarServer.Controllers
@using PortalCalendarServer.Models.DatabaseEntities
@using PortalCalendarServer.Services
@inject IDisplayService displayService

<h3>Displays</h3>

<table class="table table-hover">
    <thead>
        <tr>
            <th scope="col">Id</th>
            <th scope="col">Name</th>
            <th scope="col">MAC address</th>
            <th scope="col">Width × height</th>
            <th scope="col">Color type</th>
            <th scope="col">Firmware</th>
            <th scope="col">Battery</th>
            <th scope="col">Next wakeup
                <br />
                (local time)
            </th>
            <th scope="col">Status</th>
            <th scope="col">Last image</th>
            <th scope="col">Action</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var d in Model)
        {
            var dateCulture = displayService.GetDateCultureInfo(d);
            var tz = displayService.GetTimeZoneInfo(d);

            <tr>
                <td>@d.Id</td>
                <td>
                    @if (d.IsDefault())
                    {
                        <a href="@Url.Action(nameof(UiController.ConfigUiShow), "Ui", new { displayNumber = d.Id })">@d.Name</a>
                    }
                    else
                    {
                        <a href="@Url.Action(nameof(UiController.Home), "Ui", new { displayNumber = d.Id })">@d.Name</a>
                    }
                </td>
                <td>@d.Mac</td>
                <td>
                    @if (!d.IsDefault())
                    {
                        @($"{d.VirtualWidth()} × {d.VirtualHeight()}")
                    }
                </td>
                <td>
                    @d.DisplayType?.Name
                    <br />
                    @d.ColorVariant?.Name
                </td>
                <td>@d.Firmware</td>
                <td class="text-end">
                    @if (!d.IsDefault())
                    {
                        var batteryPercent = displayService.GetBatteryPercent(d);
                        if (batteryPercent.HasValue)
                        {
                            @($"{batteryPercent.Value:F0} %")
                        }
                        else
                        {
                            <span class="badge bg-danger">unknown</span>
                        }
                    }
                </td>
                <td>
                    @if (!d.IsDefault())
                    {
                        var nextWakeupInfo = displayService.GetNextWakeupTime(d);
                        var minutes = nextWakeupInfo.SleepInSeconds / 60;
                        var seconds = nextWakeupInfo.SleepInSeconds % 60;
                        @($"{TimeZoneInfo.ConvertTimeFromUtc(nextWakeupInfo.NextWakeup,tz).ToString("g", dateCulture)} (in {minutes} minutes and {seconds} seconds)")
                    }
                </td>
                <td>
                    @if (!d.IsDefault())
                    {
                        var missedConnects = displayService.GetMissedConnects(d);
                        if (missedConnects > 0)
                        {
                            var minFailuresStr = displayService.GetConfig(d, "alive_check_minimal_failure_count");
                            var minFailures = int.TryParse(minFailuresStr, out var mf) ? mf : 1;
                            var lastVisit = displayService.GetLastVisit(d);

                            if (missedConnects >= minFailures)
                            {
                                <span class="badge bg-danger">Frozen since @(lastVisit?.ToString("dd.MM.yyyy HH:mm") ?? "unknown")</span>
                            }
                            else
                            {
                                <span class="badge bg-info">Possibly frozen since @(lastVisit?.ToString("dd.MM.yyyy HH:mm") ?? "unknown")</span>
                            }
                            <br />
                            @if (lastVisit.HasValue)
                            {
                                var hoursSince = (int)((DateTime.UtcNow - lastVisit.Value).TotalHours + 0.5);
                                <text>@($"{hoursSince} hours, {missedConnects} missed connect(s)")</text>
                            }
                        }
                        else
                        {
                            <span class="badge bg-success">OK</span>
                        }
                    }
                </td>
                <td>
                    @if (!d.IsDefault())
                    {
                        <a href="@Url.Action(nameof(UiController.Home), "Ui", new { displayNumber = d.Id })">
                            <img src="@Url.Action(nameof(ApiController.Bitmap), "Api", new { preview_colors = true, mac = d.Mac })"
                                 style="max-height: 6rem; width: auto; border: 1px solid gray"
                                 alt="Display preview" />
                        </a>
                    }
                </td>
                <td>
                    @if (!d.IsDefault())
                    {
                        <button type="button" class="btn btn-secondary btn-sm"
                                data-bs-toggle="modal"
                                data-bs-target="#delete_modal"
                                data-display-id="@d.Id"
                                data-display-name="@d.Name">
                            Delete
                        </button>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Delete Modal -->
<div class="modal fade" id="delete_modal" tabindex="-1">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete display</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                Do you really want to <b>completely delete</b> display
                #<span class="delete_modal_display_id"></span>
                <b>"<span class="delete_modal_display_name"></span>"</b>?
            </div>
            <div class="modal-footer">
                <form id="delete_form" method="post" action="">
                    @Html.AntiForgeryToken()
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $('#delete_modal').on('show.bs.modal', function (event) {
            var button = $(event.relatedTarget);
            var modal = $(this);
            var displayId = button.data('display-id');
            modal.find('.delete_modal_display_id').text(displayId);
            modal.find('.delete_modal_display_name').text(button.data('display-name'));
            modal.find('#delete_form').attr('action', '@Url.Action(nameof(UiController.DeleteDisplay), "Ui", new { displayNumber = 0 })'.replace('/0', '/' + displayId));
        });
    </script>
}
