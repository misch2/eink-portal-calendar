@model Display
@using PortalCalendarServer.Controllers
@using PortalCalendarServer.Models.DatabaseEntities
@using PortalCalendarServer.Services

@{
    var displayService = (DisplayService)ViewData["DisplayService"]!;
}

<h3 class="mb-3">Configuration</h3>

<form action="@Url.Action(nameof(UiController.ConfigUiSave), "Ui", new { displayNumber = Model.Id })" method="post">
    @Html.AntiForgeryToken()

    <nav>
        <div class="nav nav-tabs" id="nav-tab" role="tablist">
            <button class="nav-link active" id="nav-main-tab" data-bs-toggle="tab" data-bs-target="#nav-main" type="button" role="tab" data-tab-hash="nav-main">Main</button>
            <button class="nav-link" id="nav-client-tab" data-bs-toggle="tab" data-bs-target="#nav-client" type="button" role="tab" data-tab-hash="nav-client">ePaper display (client)</button>
            <button class="nav-link" id="nav-calendar-tab" data-bs-toggle="tab" data-bs-target="#nav-calendar" type="button" role="tab" data-tab-hash="nav-calendar">Calendar (ICS)</button>
            <button class="nav-link" id="nav-metnoweather-tab" data-bs-toggle="tab" data-bs-target="#nav-metnoweather" type="button" role="tab" data-tab-hash="nav-metnoweather">Met.no weather</button>
            <button class="nav-link" id="nav-openweather-tab" data-bs-toggle="tab" data-bs-target="#nav-openweather" type="button" role="tab" data-tab-hash="nav-openweather">OpenWeather</button>
            <button class="nav-link" id="nav-telegram-tab" data-bs-toggle="tab" data-bs-target="#nav-telegram" type="button" role="tab" data-tab-hash="nav-telegram">Telegram</button>
            <button class="nav-link" id="nav-mqtt-tab" data-bs-toggle="tab" data-bs-target="#nav-mqtt" type="button" role="tab" data-tab-hash="nav-mqtt">MQTT</button>
            <button class="nav-link" id="nav-fit-tab" data-bs-toggle="tab" data-bs-target="#nav-fit" type="button" role="tab" data-tab-hash="nav-fit">Google Fit</button>
        </div>
    </nav>

    <div class="tab-content border border-top-0" id="nav-tabContent">
        <div class="tab-pane show active" id="nav-main" role="tabpanel">
            @await Html.PartialAsync("ConfigUI/_Main", Model, ViewData)
        </div>

        <div class="tab-pane" id="nav-client" role="tabpanel">
            @await Html.PartialAsync("ConfigUI/_Client", Model, ViewData)
        </div>

        <div class="tab-pane" id="nav-calendar" role="tabpanel">
            @await Html.PartialAsync("ConfigUI/_Calendar", Model, ViewData)
        </div>

        <div class="tab-pane" id="nav-metnoweather" role="tabpanel">
            @await Html.PartialAsync("ConfigUI/_MetNoWeather", Model, ViewData)
        </div>

        <div class="tab-pane" id="nav-openweather" role="tabpanel">
            @await Html.PartialAsync("ConfigUI/_OpenWeather", Model, ViewData)
        </div>

        <div class="tab-pane" id="nav-telegram" role="tabpanel">
            @await Html.PartialAsync("ConfigUI/_Telegram", Model, ViewData)
        </div>

        <div class="tab-pane" id="nav-mqtt" role="tabpanel">
            @await Html.PartialAsync("ConfigUI/_Mqtt", Model, ViewData)
        </div>

        <div class="tab-pane" id="nav-fit" role="tabpanel">
            @await Html.PartialAsync("ConfigUI/_GoogleFit", Model, ViewData)
        </div>
    </div>

    <div class="col-12 mt-3">
        <button type="submit" class="btn btn-primary">Save Configuration</button>
    </div>
</form>

@section Scripts {
    @* Fix for checkboxes not being sent when unchecked.
 See https://stackoverflow.com/questions/14067215/unchecked-checkbox-returning-null-value *@
    <script src="/scripts/checkbox_fix.js"></script>

    <script>
        $(document).ready(function() {
            // Theme selection handler
            $('#theme_id').on('change', function() {
                const themeId = $(this).val();
                const $customization = $('#theme-customization');
                const $selectedOption = $(this).find('option:selected');
                const hasConfig = $selectedOption.data('has-config') === true;
                
                if (!themeId) {
                    $customization.html('<div class="text-muted fst-italic"><small>Select a theme above to see available customization options</small></div>');
                    return;
                }
                
                if (!hasConfig) {
                    $customization.html('<div class="text-muted fst-italic"><small>This theme has no customization options</small></div>');
                    return;
                }
                
                const url = '@Url.Action(nameof(UiController.ConfigUiThemeShow), "Ui", new { displayNumber = Model.Id })' + '?themeId=' + encodeURIComponent(themeId);
                $.ajax({
                    url: url,
                    success: function(data) {
                        $customization.html(data);
                    },
                    error: function() {
                        $customization.html('<div class="text-danger"><small>Error loading theme configuration</small></div>');
                    }
                });
            }).trigger('change');

            // Hash-based tab navigation
            function activateTabFromHash() {
                const hash = window.location.hash;
                if (hash) {
                    const tabId = hash.substring(1); // Remove the '#' character
                    const tabButton = document.querySelector(`button[data-tab-hash="${tabId}"]`);
                    if (tabButton) {
                        const tab = new bootstrap.Tab(tabButton);
                        tab.show();
                    }
                }
            }

            // Activate tab on page load if hash is present
            activateTabFromHash();

            // Update URL hash when tab is shown
            $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
                const tabHash = $(e.target).attr('data-tab-hash');
                if (tabHash) {
                    // Update URL without scrolling
                    history.replaceState(null, null, '#' + tabHash);
                }
            });

            // Handle browser back/forward buttons
            window.addEventListener('hashchange', function() {
                activateTabFromHash();
            });

            // Preserve hash on form submission
            $('form').on('submit', function(e) {
                const currentHash = window.location.hash;
                if (currentHash) {
                    const form = $(this);
                    const currentAction = form.attr('action');
                    // Update form action to include the hash
                    form.attr('action', currentAction + currentHash);
                }
            });

            // Integration override toggle handler
            $('.override-toggle').on('change', function() {
                const integrationName = $(this).data('integration');
                const integrationToggle = $(`#${integrationName}`);
                const isOverrideChecked = $(this).is(':checked');
                const defaultChecked = integrationToggle.attr('data-default-checked') === 'true';
                
                if (isOverrideChecked) {
                    // Enable the integration toggle and restore the configured value
                    integrationToggle.prop('disabled', false);
                    // The checkbox will maintain its current checked state
                } else {
                    // Disable the integration toggle and show default value
                    integrationToggle.prop('checked', defaultChecked).prop('disabled', true);
                }
            });

            // Initialize state on page load for all integrations
            $('.override-toggle').each(function() {
                const integrationName = $(this).data('integration');
                const integrationToggle = $(`#${integrationName}`);
                const isOverrideChecked = $(this).is(':checked');
                const defaultChecked = integrationToggle.attr('data-default-checked') === 'true';

                
                if (!isOverrideChecked) {
                    // If not overriding, show default value and disable the toggle
                    integrationToggle.prop('checked', defaultChecked).prop('disabled', true);
                }
            });
        });
    </script>
}
