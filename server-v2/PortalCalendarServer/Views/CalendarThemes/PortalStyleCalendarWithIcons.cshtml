@model PortalCalendarServer.Services.PageViewModel
@using PortalCalendarServer.Models.Entities
@using PortalCalendarServer.Services
@using System.Globalization
@{
    Layout = null;

    var displayService = ViewContext.HttpContext.RequestServices.GetRequiredService<DisplayService>();
    displayService.UseDisplay(Model.Display);

    var dateCulture = new CultureInfo(displayService.GetConfig("date_culture") ?? "en-US");

    var now = DateTime.UtcNow;
    var wakeupInfo = Model.Display.NextWakeupTime();
    var nextWakeup = wakeupInfo.NextWakeup;
    var sleepInSeconds = wakeupInfo.SleepInSeconds;
    var schedule = wakeupInfo.Schedule;

    // Text decorator function (can be: lowercase, UPPERCASE, Capitalized)
    Func<string, string> decorator = text => text; // returns as-is by default
    decorator = text => text.ToUpperInvariant(); // UPPERCASE
    // decorator = text => dateCulture.TextInfo.ToTitleCase(text); // Capitalized

    var iconsComponent = Model.PortalIcons;
    var calendarComponent = Model.Calendar;

    var calendar = calendarComponent?.GetDetails(Model.Date);
    var icons = iconsComponent?.GenerateIcons(Model.Date, calendar?.HasEntries ?? false);
}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Calendar - Portal Style with Icons</title>
    
    @* Icon library *@
    <script src="https://cdn.jsdelivr.net/npm/iconify-icon@1.0.7/dist/iconify-icon.min.js"></script>
    
    @* Stylesheets *@
    <link rel="stylesheet" href="/css/calendar.css" />
    
    @* EPD Colors *@
    @await Html.PartialAsync("Includes/_EpdColors.cshtml", Model.CssColors)
</head>

<body>
    @* Overlay image (disabled by default) *@
    @if (false)
    {
        <div id="overlay-image"></div>
    }
    
    <div id="spacer">
        <div class="top-month-header">
            <div>
                @decorator(Model.Date.ToString("MMMM", dateCulture))
            </div>
        </div>

        <div class="day-number-big">
            @Model.Date.ToString("dd")
        </div>

        <div class="day-of-week-block">
            <div class="dow-number-and-name">
                <div>
                    @Model.Date.Day/@DateTime.DaysInMonth(Model.Date.Year, Model.Date.Month)
                </div>
                <div>
                    @decorator(Model.Date.ToString("dddd", dateCulture))
                </div>
            </div>
            <div class="separator"></div>
            <div class="bunch-of-bars">
                @for (int i = 1; i <= Model.Date.Day; i++)
                {
                    <div class="bar"></div>
                }
            </div>
        </div>

        @if (icons?.Any() == true)
        {
            <div class="icons-container">
                @foreach (var icon in icons)
                {
                    <img src="/images/portal_icons/@(icon.Name).png" class="icon@(icon.Grayed ? " grayed" : "")" alt="Portal icon" />
                }
            </div>
        }

        @if (calendar?.HasEntries == true && calendar?.TodayEvents?.Any() == true)
        {
            <div class="calendar-container">
                @foreach (var evt in calendar.TodayEvents)
                {
                    <div>
                        @if (evt.AllDay)
                        {
                            @evt.Summary
                            <!-- (celý den) -->
                        }
                        else
                        {
                            @evt.StartTime.ToString("H:mm", dateCulture)
                            @evt.Summary
                            @if (evt.DurationHours.HasValue)
                            {
                                <text>(~@((int)(evt.DurationHours.Value + 0.5)) hod.)</text>
                            }
                        }
                    </div>
                }
            </div>
        }

        <img id="aperture-logo" src="/images/Aperture_Laboratories_Logo.png" alt="Aperture Science" />

        <div id="bottom-signature">
            @* Screen generated at *@
            <iconify-icon icon="material-symbols:refresh"></iconify-icon>
            @now.ToString("H:mm", dateCulture),

            @* Screen displayed at *@
            <iconify-icon icon="material-symbols:add-to-home-screen-sharp"></iconify-icon>
            @nextWakeup.ToString("H:mm", dateCulture),
        </div>

        <div id="battery-status">
            @await Html.PartialAsync("~/Views/CalendarThemes/Includes/_BatteryStatusIcon.cshtml", Model.Display)
        </div>
    </div>
</body>
</html>
